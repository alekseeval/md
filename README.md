
# Содержание

### Тестовый модуль _cf-test_

- Требования для запуска тестов:
  - [Опции конфига config.yaml](#cfg_option)
  - [Инициализация виртуального окружения venv](#venv)
- Способы запуска тестов:
  - [Использование cf-test.sh](#cf-test)
  - [Использование pytest. Запуск из виртуального окружения](#run-venv)
- [Группировка тестовых сценариев](#groups)
- Устройство проекта:
  - Тесты
  - Фикстуры
  - Методы выполнения запросов к API
  - Вспомогательные скрипты

### GitLab CI/CD
- [Настройка GitLab-Runner](#ci-cd-settings)
- [Условия запуска CI/CD пайплайна](#ci-cd-conditions)
- [Этапы выполнения CI/CD пайплайна](#ci-cd-steps)

-----------------------------------------------------------------------


# Тестовый модуль *cf-test*

## <a name="cfg_option">Требования для запуска тестов</a>

Настройка необходимых параметров в config.yaml:

| Name              | Description                                                                                                                                  |
|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------|
| `CYFOR_DUMP_PATH` | Полный путь до файла дампа **cyfor** (значение, установленное по умолчанию, соответствует расположению на сервере **_dev4_**)                |
| `PM_DUMP_PATH`    | Полный путь до файла дампа **pm** (значение, установленное по умолчанию, соответствует расположению на сервере **_dev4_**)                   |
| `request_timeout` | Timeout http-запросов к API во время исполнения тестов (в секундах, целое число)                                                             |
| `url`             | Адрес по которому выполняются запросы к API по http (значение по умолчанию -- _https://127.0.0.1:1500_)                                      |
| `op_date`         | Дата в формате yyyy-mm-dd. Все операции в системе, выполняемые во время тестирования, будут выполняться на указанную в этом параметре дату.  |

Все параметры из списка имеют установленные значения по умолчанию.

При использовании на локальной машине, в первую очередь следует убедиться в корректности параметра `url`.

При выполнении тестов используются фикстуры завязанные на данные из тестового бэкапа.
В связи с этим необходимо убедиться в корректности параметров `CYFOR_DUMP_PATH` и `PM_DUMP_PATH`.
Дампы с тестовыми данными можно установить используя скрипт clean_db.sh. <a name="clean-db-script">Скрипт описан ниже</a>.

### <a name="venv">Инициализация виртуального окружения venv</a>
Запуск тестов осуществляется из-под виртуального окружения python3-venv.
Окружение venv должно находиться в корне проекта с установленными необходимыми библиотеками, указанными в requirements.txt

Чтобы создать и настроить виртуальное окружение необходимо запустить скрипт `init_venv.sh`. <a name="clean-db-script">Скрипт описан ниже</a>.

## Запуск тестов
### <a name="cf-test">Использование cf-test.sh</a>
Предпочтительным способом запуска тестов является использование утилиты `cf-test.sh`, написанной для этой цели (лежит в корне проекта).

При запуске утилиты без использования дополнительных параметров будет выполнена следующая последовательность действий:
1) Выполнение команды git pull для git-репозитория cyfor в текущей активной ветке
2) Пересборка панелей cyfor и pm в случае, если при выполнении первого шага были получены изменения
3) Выполнение всех доступных тестовых сценариев

Кроме того, утилита может быть запущенна со следующими опциональными параметрами:

| Name                       | Description                                                                                                                                                                                                                                                                                        |
|:---------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `-b`                       | Пересобирает панели cyfor и pm перед запуском тестов даже если в текущей ветке проекта изменений не было.                                                                                                                                                                                          |
| `--no-build`               | Не пересобирает                                                                                                                                                                                                                                                                                    |
| `-p <path>`                | Запускает все тесты по переданному пути относительно проекта cf-test. Может быть использовано для запуска одиночных тестов с указанием полного пути до функции теста.<br/> Путь указывается в формате:<br/> `-p "package_tests/test_mod.py::TestClass::test_method"`                               |
| `-m <marker_expression>`   | Запускает все тесты, входящие в состав одной или нескольких маркированных групп. Может быть передано как имя одной единственной маркированной группы, так и регулярное выражение в формате:<br/> `-m "group1 or group2 and not group3"` <br/> Все доступные группы тестов описаны [ниже](#groups). |
| `-k <keyword_expression>`  | Запускает все тесты, полный путь до которых содержит в себе переданное ключевое слово или удовлетворяет переданному регулярному выражению из ключевых слов. Например:<br/> `-k "MyClass and not method"`                                                                                           |
| `--clean-db`               | Очищает БД _cyfor_ и _pm_, после чего восстанавливает из файлов бэкапа                                                                                                                                                                                                                             |
| ~~~~~~~~~~~~~~~~~~~~~~~~~~ |                                                                                                                                                                                                                                                                                                    |

Все параметры являются опциональными и могут быть переданы в любом порядке.

### <a name="run-venv">Запуск из своего виртуального окружения, через pytest</a>
Утилита `cf-test.sh` во время работы использует python-библиотеку `pytest`, поэтому существует возможность запуска тестов напрямую посредством `pytest`. Для этого необходимо:
1) Активировать виртуальное окружение командой: `source ".../cf-test/venv/bin/activate"`
2) Перейти в директорию `.../cf-test/tests`. Важно запускать тесты именно из этой директории, чтобы `pytest` мог распознать файл pytest.ini
3) Запускать тесты используя команду `pytest <options...>` ([подробнее можно найти в документации pytest](https://docs.pytest.org/en/latest/how-to/usage.html#invoke-other))
4) Деактивировать виртуальное окружение командой `deactivate`

## <a name="groups"> Группировка тестовых сценариев</a>

Все доступные группы тестов:


| Name         | Description                                                                                                                        |
|--------------|------------------------------------------------------------------------------------------------------------------------------------|
| `connection` | Тесты, проверяющие соединение со всем панелями (core/cyfor/pm)                                                                     |
| `validators` | Тесты, проверяющие корректность работы валидации у полей форм                                                                      |
| `toctou`     | Тесты, проверяющие наличие необходимых блокировок у сущностей ([wiki](https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use)) |
| `inventory`  | Тесты, проверяющие корректность работы документов инвентаризации (все из раздела "инвентаризация")                                 |
| `stockin`    | Тесты, проверяющие корректность работы актов приходования (подгруппа `inventory`)                                                  |
| `move_task`  | Тесты, проверяющие корректность работы заданий на перемещения в смене                                                              |


## <a name="ci-cd-settings">Настройки для корректной работы CI/CD Pipeline</a>



### Установка gitlab-runner

Данный раздел полезен, если нужно создать нового раннера на другом сервере, для запуска пайплайнов.

[Guide по установке на сервер](https://sean-bradley.medium.com/installing-gitlab-runner-on-ubuntu-and-centos-80f3a2de0290)

Примечания:
- Токен инициализации лежит в настройках CI/CD gitlab
- Необходимо указать тэг 'tester' во время регистрации раннера

### Права доступа для gitlab-runner пользователя
На данный момент многие команды запускаются gitlab-runner'ом через SUDO, поэтому необходимо выдать права на использование SUDO без пароля.

### Другие настройки сервера
У пользователя postgres должны быть права на чтение файлов `CYFOR_DUMP_PATH` и `PM_DUMP_PATH`. (параметры [config.yaml](#config))

Установить глобальные настройки пильного модуля, если еще не установлены (делается через конфиг файл, расположенный в /usr/local/mgr5/etc/pm.conf)

## <a name="ci-cd-conditions">Условия запуска CI/CD пайплайна</a>

Пайплайн запускается при возникновении следующих событий, возникающих в репзитории:
- Создание Merge Request'а
- Push коммитов в существующий Merge Request
- Любой Push в master ветку

Все эти события вызывают один неизменный пайплайн, который отличается только этапом `Update backups`,
запускаемом в случае работы с master веткой 

## <a name="ci-cd-steps">Этапы выполнения CI/CD пайплайнов</a>

Далее представлены этапы выполнения пайплайна в хронологическом порядке:

### 1. Create Python venv
Этап, в ходе которого происходит подготовка виртуального окружения venv. Внутри этапа запускается скрипт <a name="init-venv-script">init_venv.sh</a>
Виртуальное окружение кэшируется.

### 2. Restore DB
Этап в ходе которого база данных восстанавливается из дампа, расположение которого берется из <a name="cfg_option">конфига</a>. Внутри этапа запускается скрипт <a name="clean-db-script">clean_db.sh</a>

### 3. Build cyfor
На данном этапе выполняется сборка проекта. Внутри этапа репозиторий полностью копируется в директорию
`/usr/local/mgr5/src/cyfor_test/` и оттуда собирается. Связано такое решение с условностями сборки проекта,
требующими фиксированного расположения в определенной директории и с тем, что _gitlab-runner_ может клонировать
репозиторий только в свое выделенное пространство, за пределы которого нельзя выйти. Кроме того, в конфиг киберлеса
добавляется опция пересоздания представлений (_CreateViews_) и запускается репликация по окончании сборки.
По итогу выполнения этапа имеем полностью работающий проект.

### 3.5 Update backups (выполняется не всегда)
Данный этап выполняется только при работе с веткой master. Его назначение -- обновить дампы БД под актуальную для
репозитория проекта структуру. Внутри выполняется скрипт <a name="update-backups-script">update_backups.sh</a>

### 4. Run Integration Tests
На данном этапе выполняется запуск тестовых сценариев посредством исполнения скрипта <a name="cf-test">cf-test.sh</a>. 
Результат исполнения тестов сохраняется в качестве артефакта в формате xml и автоматически обрабатывается GitLab-ом.
